<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Manager</title>
  <link rel="stylesheet" href="/css/events.css">
</head>
<body>
  <div class="container">
    <div class="event-list">
      <h2>Events</h2>
      <div class="event-grid">
        <% events.forEach(event => { %>
          <div class="event-card" id="event-<%= event.event_id %>">
            <h3><a href="#" onclick="loadEventDetails('<%= event.event_id %>')"><%= event.e_title %></a></h3>
            <p>Created By: <%= event.created_by_name %> - Start Time: <%= event.startTime %></p>
            <!-- <button onclick="confirmDeleteEvent('<%= event.event_id %>')">Delete Event</button> -->
          </div>
        <% }); %>
      </div>
    </div>
    
    <div id="successMessage" style="display:none; color: green;">Event deleted successfully.</div>
    
    <div id="event-details" class="transition" style="display:none;">
      <!-- Event Details will be loaded here dynamically -->
    </div>
  
    <div class="event-form transition" id="event-form" style="opacity: 0; display: none;" >
      <h2 id="form-title">Create Event</h2>
      <form id="eventForm" action="/events" method="POST">
        <input type="hidden" id="eventId" name="eventId" value="">
        
        <label for="title">Title:</label><br>
        <input type="text" id="title" name="e_title" required><br><br>
  
        <label for="description">Description:</label><br>
        <textarea id="description" name="e_description"></textarea><br><br>
  
        <label for="location">Location:</label><br>
        <input type="text" id="location" name="location"><br><br>
  
        <label for="startTime">Start Time:</label><br>
        <input type="datetime-local" id="startTime" name="startTime" required><br><br>
  
        <!-- <label for="createdBy">Created By (User ID):</label><br> -->
        <input type="hidden" id="createdBy" name="created_by" required><br><br>
  
        <button type="submit" id="submitButton">Create Event</button>
        <button type="button" id="updateButton" style="display:none;">Update Event</button>
        <button type="button" id="cancelButton" onclick="cancelForm()">Cancel</button>
      </form>
    </div>
  
    <div class="create-event">
      <button onclick="showCreateForm()" id="createButtonId">Create Event</button>
    </div>
  </div>
  
  <script>
    function showCreateForm() {
      document.getElementById('eventForm').reset(); // Reset the form fields
      document.getElementById('form-title').textContent = 'Create Event';
      document.getElementById('eventForm').setAttribute('action', '/events');
      document.getElementById('eventId').value = '';
      document.getElementById('submitButton').style.display = 'inline-block';
      document.getElementById('updateButton').style.display = 'none';
      document.getElementById('event-form').style.opacity = 1;
      document.getElementById('event-form').style.display = 'block';
      document.getElementById('event-details').style.display = 'none';
      document.querySelector('.create-event').style.display = 'none'; // Hide the "Create Event" button
    }
  
    function cancelForm() {
      document.getElementById('event-form').style.opacity = 0;
      setTimeout(() => {
        document.getElementById('event-form').style.display = 'none';
        document.querySelector('.create-event').style.display = 'block'; // Show the "Create Event" button
      }, 300);
    }
  
    function confirmDeleteEvent(eventId) {
      if (confirm('Are you sure you want to delete this event?')) {
        deleteEvent(eventId);
      }
    }
  
    function deleteEvent(eventId) {
      fetch(`/events/${eventId}`, {
        method: 'DELETE',
      })
      .then(response => {
        if (response.ok) {
          document.getElementById(`event-${eventId}`).remove(); // Remove the event from the list
          hideEventDetails(); // Hide event details after deletion
          showMessage('Event deleted successfully.');
        } else {
          console.error('Failed to delete event.');
        }
      })
      .catch(error => console.error('Error:', error));
    }
  
    function showMessage(message) {
      const messageDiv = document.getElementById('successMessage');
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
  
      // Hide the message after 10 seconds
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
  
    function loadEventDetails(eventId) {
      fetch(`/events/${eventId}`)
        .then(response => response.json())
        .then(data => {
          const eventDetails = document.getElementById('event-details');
          eventDetails.innerHTML = `
            <h2>${data.e_title}</h2>
            <p><strong>Description:</strong> ${data.e_description}</p>
            <p><strong>Location:</strong> ${data.location}</p>
            <p><strong>Start Time:</strong> ${data.startTime}</p>
            <p><strong>Created At:</strong> ${data.created_at}</p>
            <p><strong>Created By:</strong> ${data.created_by_name}</p>
            <button onclick="editEvent('${eventId}')"  style="display:none;">Edit Event</button>
            <button onclick="confirmDeleteEvent('${eventId}')">Delete Event</button>
            <button onclick="cancelDetails()">Close</button>
          `;
          eventDetails.style.display = 'block';
          eventDetails.style.opacity = 1;
          document.getElementById('event-form').style.display = 'none';
        })
        .catch(error => console.error('Error loading event details:', error));
    }
  
    function editEvent(eventId) {
      fetch(`/events/${eventId}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('form-title').textContent = 'Edit Event';
          document.getElementById('eventForm').setAttribute('action', `/events/${eventId}?_method=PUT`);
          document.getElementById('eventId').value = eventId;
          document.getElementById('title').value = data.e_title;
          document.getElementById('description').value = data.e_description;
          document.getElementById('location').value = data.location;
          document.getElementById('startTime').value = data.startTime;
          // document.getElementById('createdBy').value = data.created_by_name;
          document.getElementById('submitButton').style.display = 'none';
          document.getElementById('updateButton').style.display = 'inline-block';
          document.getElementById('event-form').style.opacity = 1;
          document.getElementById('event-form').style.display = 'block';
          document.getElementById('event-details').style.display = 'none';
          document.querySelector('.create-event').style.display = 'none'; // Hide the "Create Event" button
        })
        .catch(error => console.error('Error editing event:', error));
    }
  
    function cancelDetails() {
      hideEventDetails();
    }
  
    function hideEventDetails() {
      document.getElementById('event-details').style.opacity = 0;
      setTimeout(() => {
        document.getElementById('event-details').style.display = 'none';
      }, 300);
    }
  
    function hideCreateEventButton() {
      document.querySelector('.create-event').style.display = 'none';
    }

    // Set userId to hidden input field
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');
    document.getElementById('createdBy').value = userId;
  </script>
</body>
</html>
