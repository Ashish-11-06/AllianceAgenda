<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery</title>
    <!-- Bootstrap CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <!-- <link rel="stylesheet" href="styles.css"> -->

    <style>
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        #gallery img {
            max-width: 100%;
            max-height: 100%;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loader-container {
            display: none; /* Initially hidden */
            text-align: center;
        }

        .delete-btn {
            color: rgb(250, 72, 72);
            cursor: pointer;
            background: none;
            border: none;
            font-weight: bold;
        }

        .delete-btn:hover {
            color: darkred;
            text-decoration: underline;
        }

        .message {
            text-align: center;
            margin: 10px 0;
        }

        .message.success {
            color: green;
        }

        .message.error {
            color: red;
        }
        
        .message {
            text-align: center;
            margin: 10px 0;
            opacity: 0; /* Initially hidden */
            transition: opacity 0.5s ease-in-out; /* Smooth transition for fade in/out */
        }

        .message.success {
            color: green;
        }

        .message.show {
            color: green;
            opacity: 1; /* Make visible when 'show' class is added */
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">AllianceAgenda</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Services</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Navbar ends -->

    <!-- Form with loader for uploading -->
    <div class="jumbotron">
        <div class="container">
            <h1 class="display-4">Welcome to the Gallery</h1>

            <div id="message-container" class="message"></div> <!-- Display success/error message -->
            <!-- <div id="upload-loader" class="loader" style="display: none;"></div> Loader for upload -->

            <div id="progress-bar-container" style="width: 100%; height: 10px; background: #ddd;  display: none;">
                <div id="progress-bar" style="width: 0%; height: 100%; background: rgb(7, 205, 249); text-align: center;">
                    0% <!-- This text should be inside the progress bar -->
                </div>
            </div>
            

            <form onsubmit="uploadPhoto(event)" enctype="multipart/form-data"> <!-- Trigger uploadPhoto -->
                <input type="file" name="photo" /> <!-- File input for the photo -->
                <button type="submit">Upload</button> <!-- Submit button -->
            </form>
        </div>
    </div>

    <script>
        function uploadPhoto(event) {
            event.preventDefault(); // Prevent default form behavior

            const form = event.target; // Get the form
            const formData = new FormData(form); // Create FormData for file upload

            const progressBarContainer = document.getElementById('progress-bar-container'); // Progress bar container
            const progressBar = document.getElementById('progress-bar'); // Progress bar reference
            const messageContainer = document.getElementById('message-container'); // Message container reference

            progressBarContainer.style.display = 'block'; //display progress bar
            
            const xhr = new XMLHttpRequest(); // Create a new XMLHttpRequest

            xhr.upload.addEventListener('progress', (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100); // Calculate percentage
                    progressBar.style.width = `${percentComplete}%`; // Update width
                    progressBar.textContent = `${percentComplete}%`; // Update text
                }
            });

            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                         progressBarContainer.style.display = 'none'; // Hide progress bar when complete
                         showSuccessMessage();

            // messageContainer.className = 'message success';
            loadPhotos(); // Reload gallery with newly added image
        } else {
            messageContainer.textContent = `Error: ${xhr.statusText} (${xhr.status}). Please try again.`;
            messageContainer.className = 'message error';
        }

                    // Reset progress bar on completion
                    progressBar.style.width = '0%'; // Reset width
                    progressBar.textContent = '0%'; // Reset text
                }
            };

            xhr.open('POST', '/upload', true); // Open a POST request
            xhr.send(formData); // Send form data
        }

        
        
        function loadPhotos() {
            const loaderContainer = document.getElementById('loader-container'); // Loader container
            const gallery = document.getElementById('gallery'); // Gallery reference

            loaderContainer.style.display = 'block'; // Show loader while loading photos

            fetch('/photos')
            .then((response) => response.json())
            .then((photos) => {
                gallery.innerHTML = ''; // Clear existing content

                loaderContainer.style.display = 'none'; // Hide loader when done

                photos.forEach((photo) => {
                    const img = document.createElement('img'); // Create image
                    img.src = `data:${photo.mime_type};base64,${photo.data}`;
                    img.alt = photo.name;

                    const deleteButton = document.createElement('button'); // Create delete button
                    deleteButton.textContent = 'Delete';
                    deleteButton.className = 'delete-btn';
                    deleteButton.onclick = () => deletePhoto(photo.id); // Call delete function

                    const photoName = document.createElement('p'); // Show photo name
                    photoName.textContent = photo.name;

                    const photoContainer = document.createElement('div'); // Create container
                    photoContainer.appendChild(img);
                    photoContainer.appendChild(deleteButton);
                    photoContainer.appendChild(photoName);

                    gallery.appendChild(photoContainer); // Add to gallery
                });
            })
            .catch((error) => {
                console.error('Error loading photos:', error);

                loaderContainer.style.display = 'none'; // Hide loader on error
            });
        }

        function deletePhoto(photoId) {
            if (!confirm('Are you sure you want to delete this photo?')) {
                return; // Cancel deletion if user doesn't confirm
            }

            fetch(`/photos/${photoId}`, {
                method: 'DELETE', // DELETE request
            })
            .then((response) => {
                if (response.status === 200) {
                    console.log('Photo deleted successfully');
                    loadPhotos(); // Reload gallery
                } else {
                    console.error('Failed to delete photo');
                }
            })
            .catch((error) => {
                console.error('Error deleting photo:', error);
            });
        }

        function showSuccessMessage() {
    const messageContainer = document.getElementById('message-container'); // Get message container
    messageContainer.classList.add('show'); // Show the message by adding 'show' class
    messageContainer.textContent = "File uploaded successfully!"; // Set the success message
    setTimeout(() => {
        messageContainer.classList.remove('show'); // Hide message after a few seconds
    }, 3000); // Duration for displaying the message
}


    </script>

    
    <div id="loader-container" class="loader-container">
        <div class="loader"></div> <!-- Loader for loading photos -->
        <div>please wait...</div><br><br>
    </div>

    <body onload="loadPhotos()">
        <div id="gallery"></div> <!-- A container for the gallery -->
    </body>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="social-icons">
                <a href="#" class="fab fa-facebook-f"></a>
                <a href="#" class="fab fa-twitter"></a>
                <a href="#" class="fab fa-instagram"></a>
                <a href="#" class="fab fa-linkedin-in"></a>
            </div>
            <p>Â© 2024 AllianceAgenda. All rights reserved.</p>
        </div>
    </div>

    <!-- Footer ends -->

    <!-- Bootstrap CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
